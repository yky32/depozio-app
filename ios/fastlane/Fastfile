# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  desc "Setup code signing certificates and provisioning profiles"
  lane :setup_certificates do
    # Ensure we use username/password authentication for cert/sigh
    # Unset API key environment variables to avoid conflicts
    ENV.delete("APP_STORE_CONNECT_API_KEY_PATH")
    ENV.delete("APP_STORE_CONNECT_API_KEY")
    
    # Get App Store distribution certificate
    # cert automatically installs it in the default keychain
    cert(
      username: ENV["FASTLANE_USER"],
      team_id: "3G34999H3A"
    )
    
    # Get App Store provisioning profile
    # sigh automatically installs it in ~/Library/MobileDevice/Provisioning Profiles
    profile_path = sigh(
      username: ENV["FASTLANE_USER"],
      app_identifier: "com.depozio",
      team_id: "3G34999H3A",
      force: true
    )
    
    # Update Xcode project to use automatic signing with team ID
    # The provisioning profile will be automatically selected
    update_code_signing_settings(
      use_automatic_signing: true,
      path: "Runner.xcodeproj",
      team_id: "3G34999H3A",
      bundle_identifier: "com.depozio"
    )
    
    profile_path
  end

  desc "Deploy to App Store"
  lane :deploy_app_store do
    # Find the IPA file
    ipa_path = Dir.glob("../build/ios/ipa/*.ipa").first
    
    if ipa_path.nil?
      UI.user_error!("IPA file not found. Make sure Flutter build completed successfully.")
    end
    
    UI.message("Found IPA at: #{ipa_path}")
    
    # Upload to App Store Connect
    # Uses App Store Connect API key if available, otherwise falls back to Apple ID
    upload_to_app_store(
      ipa: ipa_path,
      force: true,
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false,
      automatic_release: false
    )
    
    UI.success("Successfully uploaded to App Store Connect!")
  end
  
  desc "Deploy to App Store and submit for review"
  lane :deploy_and_submit do
    # Ensure we're on the main branch or a release tag
    ensure_git_branch(branch: 'main')
    
    # Increment build number
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )
    
    # Find the IPA file
    ipa_path = Dir.glob("../build/ios/ipa/*.ipa").first
    
    if ipa_path.nil?
      UI.user_error!("IPA file not found. Make sure Flutter build completed successfully.")
    end
    
    UI.message("Found IPA at: #{ipa_path}")
    
    # Upload to App Store Connect and submit for review
    upload_to_app_store(
      ipa: ipa_path,
      force: true,
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: true,
      automatic_release: false
    )
    
    UI.success("Successfully uploaded and submitted for review!")
  end
end

