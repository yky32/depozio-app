# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Get the project root directory (two levels up from fastlane directory)
# Fastfile is in ios/fastlane/, so ../.. gets us to project root
FASTLANE_DIR = File.dirname(__FILE__)
IOS_DIR = File.expand_path("..", FASTLANE_DIR)
PROJECT_ROOT = File.expand_path("..", IOS_DIR)

default_platform(:ios)

platform :ios do
  desc "Build iOS app for development (Debug)"
  lane :build_debug do
    # Get dependencies
    sh("cd #{PROJECT_ROOT} && flutter pub get")
    
    # Build iOS app in debug mode (Flutter will automatically run pod install if needed)
    # Using clean environment to avoid Bundler conflicts with CocoaPods
    sh("cd #{PROJECT_ROOT} && env -u BUNDLE_GEMFILE -u BUNDLE_BIN_PATH -u BUNDLE_PATH flutter build ios --debug --no-codesign")
    
    UI.success("âœ… iOS Debug build completed!")
  end

  desc "Build iOS app for release"
  lane :build_release do
    # Get dependencies
    sh("cd #{PROJECT_ROOT} && flutter pub get")
    
    # Build iOS app in release mode (Flutter will automatically run pod install if needed)
    # Using clean environment to avoid Bundler conflicts with CocoaPods
    sh("cd #{PROJECT_ROOT} && env -u BUNDLE_GEMFILE -u BUNDLE_BIN_PATH -u BUNDLE_PATH flutter build ios --release --no-codesign")
    
    UI.success("âœ… iOS Release build completed!")
  end

  desc "Build iOS app and create IPA (requires code signing)"
  desc "Options: export_method - 'development', 'ad-hoc', 'app-store', or 'enterprise' (default: 'development')"
  lane :build_ipa do |options|
    export_method = options[:export_method] || "development"
    
    # Get dependencies
    sh("cd #{PROJECT_ROOT} && flutter pub get")
    
    # Build iOS app in release mode (Flutter will automatically run pod install if needed)
    # Using clean environment to avoid Bundler conflicts with CocoaPods
    sh("cd #{PROJECT_ROOT} && env -u BUNDLE_GEMFILE -u BUNDLE_BIN_PATH -u BUNDLE_PATH flutter build ios --release")
    
    # Build IPA using xcodebuild
    # Configure export to use automatic signing (matching the archive)
    # For app-store, ensure we're using Distribution certificate
    export_opts = {
      method: export_method,
      signingStyle: "automatic",
      teamID: "3G34999H3A"  # Your team ID from Appfile
    }
    
    # For app-store, try to ensure Distribution certificate is used
    if export_method == "app-store"
      UI.message("ðŸ“¦ Building for App Store - will use Distribution certificate")
      # Xcode should automatically select Distribution certificate for app-store export
    end
    
    build_app(
      workspace: "#{IOS_DIR}/Runner.xcworkspace",
      scheme: "Runner",
      export_method: export_method,
      output_directory: "#{PROJECT_ROOT}/build/ios/ipa",
      export_options: export_opts
    )
    
    UI.success("âœ… IPA created successfully!")
    UI.message("ðŸ“¦ IPA location: #{PROJECT_ROOT}/build/ios/ipa/")
  end

  desc "Build IPA and upload to TestFlight"
  desc "Options: skip_build - set to true to skip building and use existing IPA (default: false)"
  lane :upload_testflight do |options|
    skip_build = options[:skip_build] || false
    
    unless skip_build
      UI.important("ðŸ“¦ Building IPA for App Store...")
      UI.important("âš ï¸  Note: App Store builds require Distribution certificate and App Store provisioning profile")
      UI.important("")
      
      build_success = false
      retry_count = 0
      max_retries = 1
      
      begin
        # Build IPA with app-store export method for TestFlight
        build_ipa(export_method: "app-store")
        build_success = true
      rescue => ex
        error_msg = ex.message
        
        # Check if it's a certificate/provisioning profile error
        is_signing_error = error_msg.include?("provisioning profile") || 
                          error_msg.include?("certificate") || 
                          error_msg.include?("signing") ||
                          error_msg.include?("CodeSign") ||
                          error_msg.include?("packaging")
        
        if is_signing_error && retry_count < max_retries
          retry_count += 1
          UI.important("")
          UI.important("ðŸ”§ Detected code signing issue. Attempting to configure certificates automatically...")
          UI.important("")
          
          begin
            # Try to setup App Store signing automatically
            setup_appstore_signing
            UI.important("")
            UI.important("ðŸ”„ Retrying build with newly configured certificates...")
            UI.important("")
            
            # Retry the build
            build_ipa(export_method: "app-store")
            build_success = true
          rescue => setup_ex
            UI.error("")
            UI.error("âŒ Automatic certificate setup failed: #{setup_ex.message}")
            UI.error("")
            UI.error("   This usually means you need to set up App Store distribution certificates.")
            UI.error("")
            UI.error("   ðŸ“‹ Manual Setup (Xcode):")
            UI.error("      1. open ios/Runner.xcworkspace")
            UI.error("      2. Select Runner target â†’ Signing & Capabilities")
            UI.error("      3. Enable 'Automatically manage signing'")
            UI.error("      4. Select your team (3G34999H3A)")
            UI.error("      5. Xcode will create App Store provisioning profile automatically")
            UI.error("")
            UI.error("   ðŸ”§ Or try manual CLI setup:")
            UI.error("      bundle exec fastlane ios setup_appstore_signing")
            UI.error("")
            UI.error("   ðŸ’¡ Alternative: Build development IPA for local testing:")
            UI.error("      bundle exec fastlane ios build_ipa")
            UI.error("")
            raise
          end
        else
          # Not a signing error or already retried
          UI.error("âŒ Failed to build IPA for App Store")
          UI.error("   Error: #{error_msg}")
          UI.error("")
          
          if is_signing_error
            UI.error("   This appears to be a code signing issue.")
            UI.error("   Try running: bundle exec fastlane ios setup_appstore_signing")
          end
          UI.error("")
          raise
        end
      end
      
      unless build_success
        UI.user_error!("Failed to build IPA for App Store after setup attempts")
      end
    end
    
    # Find the IPA file
    ipa_path = "#{PROJECT_ROOT}/build/ios/ipa/Runner.ipa"
    
    unless File.exist?(ipa_path)
      UI.user_error!("âŒ IPA file not found at #{ipa_path}.\n" +
                    "   Please build the IPA first or run without skip_build option.\n" +
                    "   For development/testing, use: bundle exec fastlane ios build_ipa")
    end
    
    UI.message("ðŸš€ Uploading to TestFlight...")
    
    begin
      # Upload to TestFlight
      upload_to_testflight(
        ipa: ipa_path,
        skip_waiting_for_build_processing: false,  # Wait for processing to complete
        skip_submission: true,  # Don't automatically submit for review
        distribute_external: false,  # Internal testing only (set to true for external)
        notify_external_testers: false  # Don't notify testers automatically
      )
      
      UI.success("âœ… Successfully uploaded to TestFlight!")
      UI.message("ðŸ“± Check App Store Connect for build processing status")
    rescue => ex
      error_msg = ex.message
      
      # Check if it's an "app not found" error
      if error_msg.include?("Couldn't find app") || error_msg.include?("not found on the account")
        UI.important("")
        UI.important("ðŸ”§ App not found in App Store Connect. Attempting to create it automatically...")
        UI.important("")
        
        begin
          # Try to create the app automatically
          create_app
          UI.important("")
          UI.important("ðŸ”„ Retrying upload to TestFlight...")
          UI.important("")
          
          # Retry the upload
          upload_to_testflight(
            ipa: ipa_path,
            skip_waiting_for_build_processing: false,
            skip_submission: true,
            distribute_external: false,
            notify_external_testers: false
          )
          
          UI.success("âœ… Successfully uploaded to TestFlight!")
          UI.message("ðŸ“± Check App Store Connect for build processing status")
        rescue => create_ex
          UI.error("")
          UI.error("âŒ Failed to create app or upload: #{create_ex.message}")
          UI.error("")
          UI.error("   ðŸ“‹ Manual Setup Steps:")
          UI.error("")
          UI.error("   1. Go to App Store Connect: https://appstoreconnect.apple.com")
          UI.error("   2. Sign in with your Apple ID: wayneyu.dev@gmail.com")
          UI.error("   3. Click 'My Apps' â†’ Click the '+' button â†’ 'New App'")
          UI.error("   4. Fill in the required information:")
          UI.error("      - Platform: iOS")
          UI.error("      - Name: Depozio (or your app name)")
          UI.error("      - Primary Language: (select your language)")
          UI.error("      - Bundle ID: com.depozio")
          UI.error("      - SKU: (any unique identifier, e.g., 'depozio-001')")
          UI.error("      - User Access: Full Access (or as needed)")
          UI.error("   5. Click 'Create'")
          UI.error("")
          UI.error("   âš ï¸  Note: After creating the app, wait a few minutes for it to propagate")
          UI.error("      Then try uploading again.")
          UI.error("")
          UI.error("   ðŸ’¡ Or try creating the app using Fastlane:")
          UI.error("      bundle exec fastlane ios create_app")
          UI.error("")
          raise
        end
      else
        UI.error("âŒ Failed to upload to TestFlight")
        UI.error("   Error: #{error_msg}")
        UI.error("")
        raise
      end
    end
  end

  desc "Create app in App Store Connect"
  desc "This will register your app in App Store Connect if it doesn't exist"
  lane :create_app do
    UI.message("ðŸ“± Creating app in App Store Connect...")
    UI.important("âš ï¸  This requires App Store Connect access")
    
    begin
      produce(
        username: ENV["FASTLANE_USER"] || "wayneyu.dev@gmail.com",
        app_identifier: "com.depozio",
        app_name: "Depozio",
        team_id: "3G34999H3A",
        skip_itc: false,  # Don't skip App Store Connect creation
        skip_devcenter: false  # Don't skip Developer Center
      )
      
      UI.success("âœ… App created successfully in App Store Connect!")
      UI.message("ðŸ“ You can now upload to TestFlight using: bundle exec fastlane ios upload_testflight")
    rescue => ex
      error_msg = ex.message
      
      if error_msg.include?("already exists") || error_msg.include?("already registered")
        UI.important("â„¹ï¸  App already exists in App Store Connect")
        UI.message("   You can proceed with uploading to TestFlight")
      else
        UI.error("âŒ Failed to create app: #{error_msg}")
        UI.error("")
        UI.error("   ðŸ“‹ Manual Setup:")
        UI.error("      1. Go to https://appstoreconnect.apple.com")
        UI.error("      2. Sign in and create the app manually")
        UI.error("      3. Bundle ID: com.depozio")
        UI.error("")
        raise
      end
    end
  end

  desc "Setup App Store distribution certificates and provisioning profiles"
  desc "This will download/create Distribution certificate and App Store provisioning profile"
  lane :setup_appstore_signing do
    UI.message("ðŸ”§ Setting up App Store distribution signing...")
    UI.important("âš ï¸  This requires App Store Connect API access or Apple ID authentication")
    
    begin
      # Get or create App Store Distribution certificate
      UI.message("ðŸ“œ Getting App Store Distribution certificate...")
      get_certificates(
        development: false,  # Get Distribution certificate
        username: ENV["FASTLANE_USER"] || "wayneyu.dev@gmail.com",
        team_id: "3G34999H3A"
      )
      
      # Get or create App Store provisioning profile
      # By default (no development/adhoc specified), it gets App Store profiles
      UI.message("ðŸ“‹ Getting App Store provisioning profile...")
      get_provisioning_profile(
        app_identifier: "com.depozio",
        username: ENV["FASTLANE_USER"] || "wayneyu.dev@gmail.com",
        team_id: "3G34999H3A"
        # Not specifying development/adhoc defaults to App Store provisioning profile
      )
      
      UI.success("âœ… App Store distribution certificates and profiles are ready!")
      UI.message("ðŸ“ You can now build for App Store using: bundle exec fastlane ios build_ipa export_method:app-store")
    rescue => ex
      UI.important("âš ï¸  Automatic certificate setup failed: #{ex.message}")
      UI.important("")
      UI.important("   Alternative: Set up manually in Xcode:")
      UI.important("   1. open ios/Runner.xcworkspace")
      UI.important("   2. Select Runner target â†’ Signing & Capabilities")
      UI.important("   3. Enable 'Automatically manage signing'")
      UI.important("   4. Select your team")
      UI.important("   5. Xcode will create certificates automatically")
      UI.important("")
      raise
    end
  end

  desc "Increment build number"
  lane :increment_build do
    increment_build_number(
      xcodeproj: "#{IOS_DIR}/Runner.xcodeproj"
    )
    UI.success("âœ… Build number incremented!")
  end

  desc "Clean iOS build artifacts"
  lane :clean do
    sh("cd #{PROJECT_ROOT} && flutter clean")
    sh("cd #{IOS_DIR} && rm -rf Pods Podfile.lock")
    begin
      sh("cd #{IOS_DIR} && env -u BUNDLE_GEMFILE -u BUNDLE_BIN_PATH -u BUNDLE_PATH /opt/homebrew/bin/pod install", log: false)
    rescue => ex
      # Silently continue - user can run pod install manually if needed
    end
    UI.success("âœ… Clean completed!")
  end
end

platform :android do
  desc "Build Android app for development (Debug)"
  lane :build_debug do
    # Get dependencies
    sh("cd #{PROJECT_ROOT} && flutter pub get")
    
    # Build Android app in debug mode
    sh("cd #{PROJECT_ROOT} && flutter build apk --debug")
    
    UI.success("âœ… Android Debug APK built successfully!")
    UI.message("ðŸ“¦ APK location: #{PROJECT_ROOT}/build/app/outputs/flutter-apk/app-debug.apk")
  end

  desc "Build Android app for release (APK)"
  lane :build_release_apk do
    # Get dependencies
    sh("cd #{PROJECT_ROOT} && flutter pub get")
    
    # Build Android app in release mode (APK)
    sh("cd #{PROJECT_ROOT} && flutter build apk --release")
    
    UI.success("âœ… Android Release APK built successfully!")
    UI.message("ðŸ“¦ APK location: #{PROJECT_ROOT}/build/app/outputs/flutter-apk/app-release.apk")
  end

  desc "Build Android app for release (App Bundle)"
  lane :build_release_bundle do
    # Get dependencies
    sh("cd #{PROJECT_ROOT} && flutter pub get")
    
    # Build Android app in release mode (App Bundle)
    sh("cd #{PROJECT_ROOT} && flutter build appbundle --release")
    
    UI.success("âœ… Android Release App Bundle built successfully!")
    UI.message("ðŸ“¦ AAB location: #{PROJECT_ROOT}/build/app/outputs/bundle/release/app-release.aab")
  end

  desc "Clean Android build artifacts"
  lane :clean do
    sh("cd #{PROJECT_ROOT} && flutter clean")
    sh("cd #{PROJECT_ROOT}/android && ./gradlew clean")
    UI.success("âœ… Clean completed!")
  end
end

# Common lanes that work for both platforms
desc "Get Flutter dependencies"
lane :get_dependencies do
  sh("cd #{PROJECT_ROOT} && flutter pub get")
  UI.success("âœ… Dependencies fetched!")
end

desc "Run Flutter tests"
lane :test do
  sh("cd #{PROJECT_ROOT} && flutter test")
  UI.success("âœ… Tests completed!")
end

desc "Clean all build artifacts"
lane :clean_all do
  sh("cd #{PROJECT_ROOT} && flutter clean")
  sh("cd #{IOS_DIR} && rm -rf Pods Podfile.lock")
  begin
    sh("cd #{IOS_DIR} && env -u BUNDLE_GEMFILE -u BUNDLE_BIN_PATH -u BUNDLE_PATH /opt/homebrew/bin/pod install", log: false)
  rescue => ex
    # Silently continue - user can run pod install manually if needed
  end
  sh("cd #{PROJECT_ROOT}/android && ./gradlew clean")
  UI.success("âœ… All build artifacts cleaned!")
end

