# Fastlane Configuration for iOS App Store Deployment
# Documentation: https://docs.fastlane.tools

default_platform(:ios)

platform :ios do
  desc "Debug: Check environment variables (for troubleshooting)"
  lane :check_env do
    UI.message("=== Environment Variables Check ===")
    UI.message("FASTLANE_USER: #{ENV['FASTLANE_USER'] ? 'SET (' + ENV['FASTLANE_USER'] + ')' : 'NOT SET'}")
    UI.message("FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: #{ENV['FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD'] ? 'SET' : 'NOT SET'}")
    UI.message("FASTLANE_PASSWORD: #{ENV['FASTLANE_PASSWORD'] ? 'SET' : 'NOT SET'}")
    UI.message("APP_STORE_CONNECT_API_KEY_ID: #{ENV['APP_STORE_CONNECT_API_KEY_ID'] ? 'SET' : 'NOT SET'}")
    UI.message("APP_STORE_CONNECT_ISSUER_ID: #{ENV['APP_STORE_CONNECT_ISSUER_ID'] ? 'SET' : 'NOT SET'}")
    UI.message("APP_STORE_CONNECT_API_KEY_PATH: #{ENV['APP_STORE_CONNECT_API_KEY_PATH'] ? 'SET (' + ENV['APP_STORE_CONNECT_API_KEY_PATH'] + ')' : 'NOT SET'}")
    
    if ENV['APP_STORE_CONNECT_API_KEY_PATH']
      key_exists = File.exist?(File.expand_path(ENV['APP_STORE_CONNECT_API_KEY_PATH']))
      UI.message("API Key file exists: #{key_exists}")
    end
    
    UI.message("Team ID: 3G34999H3A")
    UI.message("App Identifier: com.depozio")
    UI.message("================================")
  end

  desc "Download certificates and provisioning profiles"
  lane :certificates do
    # Expand ~ to full path and check if API key file exists
    api_key_path = nil
    if ENV["APP_STORE_CONNECT_API_KEY_PATH"]
      api_key_path = File.expand_path(ENV["APP_STORE_CONNECT_API_KEY_PATH"])
      unless File.exist?(api_key_path)
        UI.important("API key file not found at: #{api_key_path}")
        UI.important("Falling back to Apple ID authentication")
        api_key_path = nil
      end
    end
    
    # Use App Store Connect API key if available, otherwise use username/password
    if api_key_path
      UI.message("Using App Store Connect API key: #{api_key_path}")
      
      cert(
        api_key_path: api_key_path,
        team_id: "3G34999H3A"
      )
      
      sigh(
        api_key_path: api_key_path,
        app_identifier: "com.depozio",
        team_id: "3G34999H3A",
        force: true
      )
    else
      UI.message("Using Apple ID authentication")
      
      # Verify credentials are available
      unless ENV["FASTLANE_USER"]
        UI.user_error!("FASTLANE_USER must be set when API key is not available")
      end
      
      unless ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"]
        UI.user_error!("FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD must be set for 2FA accounts")
      end
      
      # Set password for fastlane
      ENV["FASTLANE_PASSWORD"] = ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"]
      
      cert(
        username: ENV["FASTLANE_USER"],
        team_id: "3G34999H3A"
      )
      
      sigh(
        username: ENV["FASTLANE_USER"],
        app_identifier: "com.depozio",
        team_id: "3G34999H3A",
        force: true
      )
    end
  end

  desc "Build and export IPA"
  lane :build do
    # Download certificates first
    certificates
    
    # Build the app using gym (build_app)
    # gym automatically handles code signing with the certificates we downloaded
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      clean: true,
      include_bitcode: false,
      include_symbols: true
    )
  end

  desc "Upload to App Store Connect"
  lane :upload do
    # Find the IPA
    ipa_path = Dir.glob("../build/ios/ipa/*.ipa").first
    
    unless ipa_path
      UI.user_error!("IPA not found. Run 'fastlane build' first.")
    end
    
    UI.message("Uploading: #{ipa_path}")
    
    upload_to_app_store(
      ipa: ipa_path,
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false
    )
    
    UI.success("Upload complete!")
  end

  desc "Deploy to App Store (build + upload)"
  lane :deploy do
    build
    upload
  end
end
