# Fastlane Configuration for iOS App Store Deployment
# Documentation: https://docs.fastlane.tools

default_platform(:ios)

platform :ios do
  desc "Debug: Check environment variables (for troubleshooting)"
  lane :check_env do
    UI.message("=== Environment Variables Check ===")
    UI.message("FASTLANE_USER: #{ENV['FASTLANE_USER'] ? 'SET (' + ENV['FASTLANE_USER'] + ')' : 'NOT SET'}")
    UI.message("FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: #{ENV['FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD'] ? 'SET' : 'NOT SET'}")
    UI.message("FASTLANE_PASSWORD: #{ENV['FASTLANE_PASSWORD'] ? 'SET' : 'NOT SET'}")
    UI.message("APP_STORE_CONNECT_API_KEY_ID: #{ENV['APP_STORE_CONNECT_API_KEY_ID'] ? 'SET' : 'NOT SET'}")
    UI.message("APP_STORE_CONNECT_ISSUER_ID: #{ENV['APP_STORE_CONNECT_ISSUER_ID'] ? 'SET' : 'NOT SET'}")
    UI.message("APP_STORE_CONNECT_API_KEY_PATH: #{ENV['APP_STORE_CONNECT_API_KEY_PATH'] ? 'SET (' + ENV['APP_STORE_CONNECT_API_KEY_PATH'] + ')' : 'NOT SET'}")
    
    if ENV['APP_STORE_CONNECT_API_KEY_PATH']
      key_exists = File.exist?(File.expand_path(ENV['APP_STORE_CONNECT_API_KEY_PATH']))
      UI.message("API Key file exists: #{key_exists}")
    end
    
    UI.message("Team ID: 3G34999H3A")
    UI.message("App Identifier: com.depozio")
    UI.message("================================")
  end

  desc "Download certificates and provisioning profiles"
  lane :certificates do
    # Check for App Store Connect API key
    api_key_path = nil
    api_key_id = ENV["APP_STORE_CONNECT_API_KEY_ID"]
    api_key_issuer_id = ENV["APP_STORE_CONNECT_ISSUER_ID"]
    
    if api_key_id
      # Try to find the API key file
      # Don't use ENV["APP_STORE_CONNECT_API_KEY_PATH"] as it might confuse Fastlane's auto-detection
      possible_paths = [
        "#{ENV['HOME']}/private_keys/AuthKey_#{api_key_id}.p8",
        "~/private_keys/AuthKey_#{api_key_id}.p8"
      ].compact
      
      possible_paths.each do |path|
        expanded_path = File.expand_path(path)
        if File.exist?(expanded_path)
          api_key_path = expanded_path
          break
        end
      end
      
      unless api_key_path
        UI.important("API key file not found. Tried: #{possible_paths.join(', ')}")
        UI.important("Falling back to Apple ID authentication")
      end
    end
    
    # Use App Store Connect API key if available, otherwise use username/password
    if api_key_path && File.exist?(api_key_path)
      UI.message("Using App Store Connect API key: #{api_key_path}")
      
      # Verify file content starts with BEGIN PRIVATE KEY
      first_line = File.readlines(api_key_path).first&.strip
      unless first_line == "-----BEGIN PRIVATE KEY-----"
        UI.user_error!("Invalid API key file format. First line should be '-----BEGIN PRIVATE KEY-----', got: #{first_line}")
      end
      
      # Read the key content from file
      key_content = File.read(api_key_path)
      
      # Use api_key hash format instead of api_key_path to avoid JSON parsing issues
      # Fastlane expects key_content as a string, not a file path
      unless api_key_issuer_id
        UI.user_error!("APP_STORE_CONNECT_ISSUER_ID must be set when using API key")
      end
      
      api_key_hash = {
        key_id: api_key_id,
        issuer_id: api_key_issuer_id,
        key_content: key_content,
        is_key_content_base64: false
      }
      
      cert(
        api_key: api_key_hash,
        team_id: "3G34999H3A"
      )
      
      sigh(
        api_key: api_key_hash,
        app_identifier: "com.depozio",
        team_id: "3G34999H3A",
        force: true
      )
    else
      UI.message("Using Apple ID authentication")
      
      # Verify credentials are available
      unless ENV["FASTLANE_USER"]
        UI.user_error!("FASTLANE_USER must be set when API key is not available")
      end
      
      unless ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"]
        UI.user_error!("FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD must be set for 2FA accounts")
      end
      
      # Set password for fastlane
      ENV["FASTLANE_PASSWORD"] = ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"]
      
      cert(
        username: ENV["FASTLANE_USER"],
        team_id: "3G34999H3A"
      )
      
      sigh(
        username: ENV["FASTLANE_USER"],
        app_identifier: "com.depozio",
        team_id: "3G34999H3A",
        force: true
      )
    end
  end

  desc "Build and export IPA"
  lane :build do
    # Download certificates first
    certificates
    
    # Build the app using gym (build_app)
    # gym automatically handles code signing with the certificates we downloaded
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      clean: true,
      include_bitcode: false,
      include_symbols: true
    )
  end

  desc "Upload to App Store Connect"
  lane :upload do
    # Find the IPA
    ipa_path = Dir.glob("../build/ios/ipa/*.ipa").first
    
    unless ipa_path
      UI.user_error!("IPA not found. Run 'fastlane build' first.")
    end
    
    UI.message("Uploading: #{ipa_path}")
    
    # Prepare API key if available (same format as certificates lane)
    upload_options = {
      ipa: ipa_path,
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false
    }
    
    # Use API key if available
    api_key_id = ENV["APP_STORE_CONNECT_API_KEY_ID"]
    api_key_issuer_id = ENV["APP_STORE_CONNECT_ISSUER_ID"]
    
    if api_key_id && api_key_issuer_id
      possible_paths = [
        "#{ENV['HOME']}/private_keys/AuthKey_#{api_key_id}.p8",
        "~/private_keys/AuthKey_#{api_key_id}.p8"
      ].compact
      
      api_key_path = nil
      possible_paths.each do |path|
        expanded_path = File.expand_path(path)
        if File.exist?(expanded_path)
          api_key_path = expanded_path
          break
        end
      end
      
      if api_key_path
        key_content = File.read(api_key_path)
        upload_options[:api_key] = {
          key_id: api_key_id,
          issuer_id: api_key_issuer_id,
          key_content: key_content,
          is_key_content_base64: false
        }
      end
    end
    
    upload_to_app_store(upload_options)
    
    UI.success("Upload complete!")
  end

  desc "Deploy to App Store (build + upload)"
  lane :deploy do
    build
    upload
  end
end
