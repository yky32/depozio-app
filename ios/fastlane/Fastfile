# Fastlane Configuration for iOS App Store Deployment
# Documentation: https://docs.fastlane.tools

default_platform(:ios)

platform :ios do
  desc "Download certificates and provisioning profiles"
  lane :certificates do
    # Use App Store Connect API key if available, otherwise use username/password
    if ENV["APP_STORE_CONNECT_API_KEY_PATH"] && File.exist?(File.expand_path(ENV["APP_STORE_CONNECT_API_KEY_PATH"]))
      UI.message("Using App Store Connect API key")
      
      cert(
        api_key_path: ENV["APP_STORE_CONNECT_API_KEY_PATH"],
        team_id: "3G34999H3A"
      )
      
      sigh(
        api_key_path: ENV["APP_STORE_CONNECT_API_KEY_PATH"],
        app_identifier: "com.depozio",
        team_id: "3G34999H3A",
        force: true
      )
    else
      UI.message("Using Apple ID authentication")
      
      # Ensure password is set
      unless ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"]
        ENV["FASTLANE_PASSWORD"] = ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"] if ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"]
      end
      
      cert(
        username: ENV["FASTLANE_USER"],
        team_id: "3G34999H3A"
      )
      
      sigh(
        username: ENV["FASTLANE_USER"],
        app_identifier: "com.depozio",
        team_id: "3G34999H3A",
        force: true
      )
    end
  end

  desc "Build and export IPA"
  lane :build do
    # Download certificates first
    certificates
    
    # Build the app
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      clean: true
    )
  end

  desc "Upload to App Store Connect"
  lane :upload do
    # Find the IPA
    ipa_path = Dir.glob("../build/ios/ipa/*.ipa").first
    
    unless ipa_path
      UI.user_error!("IPA not found. Run 'fastlane build' first.")
    end
    
    UI.message("Uploading: #{ipa_path}")
    
    upload_to_app_store(
      ipa: ipa_path,
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false
    )
    
    UI.success("Upload complete!")
  end

  desc "Deploy to App Store (build + upload)"
  lane :deploy do
    build
    upload
  end
end
