name: Build and Deploy to TestFlight

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number (optional, auto-increments if not provided)'
        required: false
        type: string

env:
  FLUTTER_VERSION: '3.38.3'
  XCODE_VERSION: '16.4'

jobs:
  build-and-deploy:
    name: Build iOS and Deploy to TestFlight
    runs-on: macos-15
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Generate localization files
        run: flutter gen-l10n

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: |
          pod install --repo-update

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ios

      - name: Install Fastlane
        working-directory: ios
        run: |
          bundle install

      - name: Decode App Store Connect API Key
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          mkdir -p ~/private_keys
          echo "$APP_STORE_CONNECT_API_KEY" > ~/private_keys/AuthKey.p8
          chmod 600 ~/private_keys/AuthKey.p8

      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Build: $BUILD_NUMBER"

      - name: Increment build number (if manual trigger)
        if: github.event_name == 'workflow_dispatch' && inputs.build_number != ''
        run: |
          sed -i '' "s/version: .*/version: $(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/\+.*//')+${{ inputs.build_number }}/" pubspec.yaml

      - name: Build iOS app
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_PATH: ~/private_keys/AuthKey.p8
          TEAM_ID: ${{ secrets.TEAM_ID || '3G34999H3A' }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
        working-directory: ios
        run: |
          bundle exec fastlane beta

      - name: Upload build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: |
            build/ios/iphoneos/*.ipa
            build/ios/iphoneos/*.dSYM.zip
          retention-days: 7

      - name: Clean up
        if: always()
        run: |
          rm -rf ~/private_keys

