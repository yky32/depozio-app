name: Deploy to TestFlight/App Store

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Deployment type'
        required: true
        default: 'testflight'
        type: choice
        options:
          - testflight
          - appstore

env:
  FLUTTER_VERSION: '3.24.0'
  XCODE_VERSION: '16.4'
  TEAM_ID: '3G34999H3A'
  APP_IDENTIFIER: 'com.depozio'

jobs:
  deploy:
    name: Build and Deploy iOS App
    runs-on: macos-15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ios

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: |
          pod install --repo-update

      - name: Get Flutter dependencies
        run: |
          flutter pub get
          flutter precache --ios

      - name: Generate localization files
        run: flutter gen-l10n

      - name: Setup App Store Connect API Key
        env:
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          mkdir -p ~/private_keys
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > ~/private_keys/AuthKey.p8
          chmod 600 ~/private_keys/AuthKey.p8
          echo "APP_STORE_CONNECT_API_KEY_PATH=$HOME/private_keys/AuthKey.p8" >> $GITHUB_ENV
          echo "APP_STORE_CONNECT_API_KEY_ID=${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" >> $GITHUB_ENV
          echo "APP_STORE_CONNECT_ISSUER_ID=${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" >> $GITHUB_ENV

      - name: Setup Match (if configured)
        if: secrets.MATCH_GIT_URL != ''
        env:
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        run: |
          echo "MATCH_GIT_URL=$MATCH_GIT_URL" >> $GITHUB_ENV
          if [ -n "$MATCH_PASSWORD" ]; then
            echo "MATCH_PASSWORD is set" >> $GITHUB_ENV
          fi

      - name: Build Flutter app
        run: |
          flutter build ios --release --no-codesign

      - name: Run Fastlane
        working-directory: ios
        env:
          APP_STORE_CONNECT_API_KEY_PATH: ${{ env.APP_STORE_CONNECT_API_KEY_PATH }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ env.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ env.APP_STORE_CONNECT_ISSUER_ID }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          TEAM_ID: ${{ env.TEAM_ID }}
          FLUTTER_BUILD_NUMBER: ${{ github.run_number }}
        run: |
          echo "ðŸ“¦ Building and deploying iOS app..."
          echo "Build Number: $FLUTTER_BUILD_NUMBER"
          echo "Team ID: $TEAM_ID"
          
          # Determine which lane to run
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.deploy_type }}" == "appstore" ]; then
            echo "ðŸš€ Deploying to App Store..."
            bundle exec fastlane release
          else
            echo "ðŸš€ Deploying to TestFlight..."
            bundle exec fastlane beta
          fi

      - name: Upload build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-artifacts
          path: |
            ios/build/*.ipa
            ios/build/*.dSYM.zip
          retention-days: 7

